<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="/src/styles.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OSC Bridge - æ§åˆ¶é¢æ¿</title>

  </head>

  <body>
    <div class="container">
      <header class="header" data-tauri-drag-region>
        <div class="status-item" data-tauri-drag-region>
          <span class="status-indicator" id="ws-status"></span>
          <span class="status-label">WebSocket: </span>
          <span id="ws-status-text">æœªè¿æ¥</span>
        </div>
        <div class="status-divider" data-tauri-drag-region>|</div>
        <div class="status-item" data-tauri-drag-region>
          <span class="status-label">ç›‘å¬: </span>
          <span id="listen-ports-display">127.0.0.1:7879/9222</span>
        </div>
        <div class="status-divider" data-tauri-drag-region>|</div>
        <div class="status-item" data-tauri-drag-region>
          <span class="status-label">ç›®æ ‡: </span>
          <span id="target-ports-display">127.0.0.1:7878/9223</span>
        </div>
        <div class="header-actions">
            <button id="settings-btn" class="icon-btn" title="è®¾ç½®">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </button>
            <button id="close-btn" class="icon-btn" title="å…³é—­">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
      </header>

      <div class="main-content">
        <!-- å·¦ä¾§ä¸»é¢æ¿ -->
        <div class="main-panel">
          <div class="card">
            <form id="osc-form">
            <div class="form-group">
                <label for="osc-address">OSC åœ°å€</label>
                <input type="text" id="osc-address" value="/Test">
            </div>
            <div class="form-group">
                <label for="osc-args">å‚æ•° (ä»¥é€—å·åˆ†éš”)</label>
                <input type="text" id="osc-args" value="1">
              </div>
              <button type="submit" class="btn btn-primary">å‘é€</button>
            </form>
            </div>
            
          <!-- ç³»ç»Ÿæ—¥å¿—åŒºåŸŸ -->
          <div class="card system-log-card">
            <div class="log-header">
              <h4>ç³»ç»Ÿæ—¥å¿—</h4>
              <button id="clear-system-log" class="clear-icon-btn" title="æ¸…é™¤ç³»ç»Ÿæ—¥å¿—">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3,6 5,6 21,6"></polyline>
                  <path d="m19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1 2-2h4a2,2 0 0,1 2,2v2"></path>
                  <line x1="10" y1="11" x2="10" y2="17"></line>
                  <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
              </button>
            </div>
            <div id="system-log-container" class="log-container"></div>
          </div>
        </div>

        <!-- å³ä¾§OSCæ—¥å¿—ä¾§è¾¹æ  -->
        <div class="side-panel">
            <div class="log-controls">
            <h4>OSC æ¶ˆæ¯æ—¥å¿—</h4>
            <div>
              <label class="checkbox-label">
                <input type="checkbox" id="auto-scroll" checked>
                è‡ªåŠ¨æ»šåŠ¨
              </label>
            </div>
          </div>
          <div class="log-column">
            <div class="log-header">
              <h3>å‘é€ OSC (â†’)</h3>
              <div class="log-controls-inline">
                <div class="search-box">
                  <input type="text" id="sent-search" class="search-input" placeholder="æœç´¢... (æ”¯æŒå¤šå…³é”®è¯)" title="æœç´¢å‘é€æ—¥å¿—ï¼Œæ”¯æŒç©ºæ ¼åˆ†éš”å¤šä¸ªå…³é”®è¯">
                  <button id="sent-search-btn" class="search-btn" title="æœç´¢">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.35-4.35"></path>
                    </svg>
                  </button>
                  <button id="sent-clear-search" class="clear-search-btn" title="æ¸…é™¤æœç´¢" style="display: none;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </div>
                <button id="clear-sent-log" class="clear-icon-btn" title="æ¸…é™¤å‘é€æ—¥å¿—">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3,6 5,6 21,6"></polyline>
                    <path d="m19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1 2-2h4a2,2 0 0,1 2,2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                  </svg>
                </button>
              </div>
            </div>
            <div id="sent-log-container" class="log-container"></div>
          </div>
          <div class="log-column">
            <div class="log-header">
              <h3>æ¥æ”¶ OSC (â†)</h3>
              <div class="log-controls-inline">
                <div class="search-box">
                  <input type="text" id="received-search" class="search-input" placeholder="æœç´¢... (æ”¯æŒå¤šå…³é”®è¯)" title="æœç´¢æ¥æ”¶æ—¥å¿—ï¼Œæ”¯æŒç©ºæ ¼åˆ†éš”å¤šä¸ªå…³é”®è¯">
                  <button id="received-search-btn" class="search-btn" title="æœç´¢">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.35-4.35"></path>
                    </svg>
                  </button>
                  <button id="received-clear-search" class="clear-search-btn" title="æ¸…é™¤æœç´¢" style="display: none;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </div>
                <button id="clear-received-log" class="clear-icon-btn" title="æ¸…é™¤æ¥æ”¶æ—¥å¿—">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3,6 5,6 21,6"></polyline>
                    <path d="m19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1 2-2h4a2,2 0 0,1 2,2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                  </svg>
                </button>
              </div>
            </div>
            <div id="received-log-container" class="log-container"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- è®¾ç½®çª—å£ -->
    <div id="settings-modal" class="modal-overlay" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2>è®¾ç½®</h2>
          <button id="close-settings-btn" class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
          <div class="settings-group">
            <label>WebSocket åœ°å€</label>
            <div id="ws-address-setting">
              <input type="text" id="ws-url-input" class="settings-input" value="ws://localhost:9122">
            </div>
          </div>
          <div class="settings-group">
            <label>ç›‘å¬ç«¯å£</label>
            <div id="listen-ports-container" class="settings-list">
              <!-- ç›‘å¬ç«¯å£åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
            <button id="add-listen-port-btn" class="btn-add-item">+ æ·»åŠ ç«¯å£</button>
          </div>
          <div class="settings-group">
            <label>è½¬å‘ç›®æ ‡</label>
            <div id="forward-targets-container" class="settings-list">
              <!-- è½¬å‘ç›®æ ‡åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
            <button id="add-forward-target-btn" class="btn-add-item">+ æ·»åŠ ç›®æ ‡</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/osc-js/lib/osc.min.js"></script>
    <script>
      // å­˜å‚¨åŸå§‹æ—¥å¿—æ•°æ®
      let sentLogData = [];
      let receivedLogData = [];
      let systemLogData = [];

      // æœç´¢çŠ¶æ€
      let sentSearchTerm = '';
      let receivedSearchTerm = '';

      // WebSocket è¿æ¥
      let ws;
      let reconnectInterval;

      // è·å–DOMå…ƒç´ 
      const systemLogContainer = document.getElementById('system-log-container');
      const sentLogContainer = document.getElementById('sent-log-container');
      const receivedLogContainer = document.getElementById('received-log-container');
      const clearSystemLogBtn = document.getElementById('clear-system-log');
      const clearSentLogBtn = document.getElementById('clear-sent-log');
      const clearReceivedLogBtn = document.getElementById('clear-received-log');
      
      // çŠ¶æ€æŒ‡ç¤ºå™¨å…ƒç´ 
      const wsStatusIndicator = document.getElementById('ws-status');
      const wsStatusText = document.getElementById('ws-status-text');
      
      // æœç´¢ç›¸å…³å…ƒç´ 
      const sentSearchInput = document.getElementById('sent-search');
      const sentSearchBtn = document.getElementById('sent-search-btn');
      const sentClearSearchBtn = document.getElementById('sent-clear-search');
      const receivedSearchInput = document.getElementById('received-search');
      const receivedSearchBtn = document.getElementById('received-search-btn');
      const receivedClearSearchBtn = document.getElementById('received-clear-search');
      
      // è®¾ç½®çª—å£å…ƒç´ 
      const settingsBtn = document.getElementById('settings-btn');
      const settingsModal = document.getElementById('settings-modal');
      const closeSettingsBtn = document.getElementById('close-settings-btn');
      const wsUrlInput = document.getElementById('ws-url-input');
      const listenPortsContainer = document.getElementById('listen-ports-container');
      const addListenPortBtn = document.getElementById('add-listen-port-btn');
      const forwardTargetsContainer = document.getElementById('forward-targets-container');
      const addForwardTargetBtn = document.getElementById('add-forward-target-btn');

      // åˆ›å»ºæ—¥å¿—å…ƒç´ 
      function createLogElement(message, isOSC = false) {
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        
        const timestamp = new Date().toLocaleTimeString('zh-CN', { 
          hour12: false,
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        
        // å¦‚æœæ˜¯OSCæ—¥å¿—ï¼Œè¿›è¡Œç‰¹æ®Šçš„é¢œè‰²å¤„ç†
        const processedMessage = isOSC ? colorizeOSCMessage(message) : message;
        
        logEntry.innerHTML = `
          <span class="log-time">[${timestamp}]</span>
          <span class="log-message">${processedMessage}</span>
        `;
        
        return logEntry;
      }

      // ä¸ºOSCæ—¥å¿—æ¶ˆæ¯æ·»åŠ é¢œè‰²
      function colorizeOSCMessage(message) {
        let colorized = message;

        // é¡ºåºå¾ˆé‡è¦ï¼Œä»æœ€å…·ä½“çš„è§„åˆ™å¼€å§‹
        
        // 1. OSCåœ°å€ - æ©™è‰²
        colorized = colorized.replace(/(åœ°å€: )([^\s|]+)/g, '$1<span class="osc-address">$2</span>');

        // 2. OSCæ•°å€¼ (åŒ…æ‹¬å¸ƒå°”å€¼) - çº¢è‰²
        colorized = colorized.replace(/(å€¼: )(true|false|[-+]?\d*\.?\d+(?:[eE][-+]?\d+)?)/g, '$1<span class="osc-value">$2</span>');

        // 3. OSCç±»å‹ - ç°è‰²
        colorized = colorized.replace(/(ç±»å‹: )(\w+)/g, '$1<span class="osc-type">$2</span>');
        
        // 4. å®¢æˆ·ç«¯ID (WebSocket) - è“è‰²
        colorized = colorized.replace(/(\[WS #\d+\])/g, '<span class="osc-client-id">$1</span>');

        // 5. æ¥æº (UDP IP) - ç»¿è‰² (åªç»™IPä¸Šè‰²)
        colorized = colorized.replace(/(\[\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}:\d+\])/g, '<span class="osc-source">$1</span>');

        // 6. è½¬å‘æ•°é‡ - ç»¿è‰²
        colorized = colorized.replace(/(\d+\/\d+)(?= ä¸ª(?:Target|WS))/g, '<span class="osc-count">$1</span>');
        
        // 7. BundleåŒ…ä¿¡æ¯ - ç°è‰²
        colorized = colorized.replace(/(åŒ… #\d+:)/g, '<span class="osc-type">$1</span>');

        return colorized;
      }

      // è§£ææœç´¢å…³é”®è¯ï¼ˆæ”¯æŒå¤šå…³é”®è¯ç©ºæ ¼åˆ†éš”ï¼‰
      function parseSearchTerms(searchTerm) {
        if (!searchTerm) return [];
        return searchTerm.trim().split(/\s+/).filter(term => term.length > 0);
      }

      // æ£€æŸ¥æ–‡æœ¬æ˜¯å¦åŒ¹é…æ‰€æœ‰æœç´¢å…³é”®è¯
      function matchesAllTerms(text, searchTerms) {
        if (!searchTerms || searchTerms.length === 0) return true;
        
        const lowerText = text.toLowerCase();
        return searchTerms.every(term => 
          lowerText.includes(term.toLowerCase())
        );
      }

      // é«˜äº®æœç´¢å…³é”®è¯ï¼ˆæ”¯æŒå¤šå…³é”®è¯ï¼‰
      function highlightSearchTerm(text, searchTerm) {
        if (!searchTerm) return text;
        
        const searchTerms = parseSearchTerms(searchTerm);
        if (searchTerms.length === 0) return text;
        
        let highlightedText = text;
        
        // æŒ‰å…³é”®è¯é•¿åº¦å€’åºæ’åˆ—ï¼Œé¿å…çŸ­å…³é”®è¯è¦†ç›–é•¿å…³é”®è¯çš„é«˜äº®
        const sortedTerms = searchTerms.sort((a, b) => b.length - a.length);
        
        sortedTerms.forEach(term => {
          const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const regex = new RegExp(`(${escapedTerm})`, 'gi');
          // é¿å…åœ¨å·²æœ‰çš„HTMLæ ‡ç­¾å†…è¿›è¡Œæ›¿æ¢
          highlightedText = highlightedText.replace(new RegExp(`(?![^<]*>)${escapedTerm}`, 'gi'), '<span class="search-highlight">$&</span>');
        });
        
        return highlightedText;
      }

      // è¿‡æ»¤æ—¥å¿—æ¡ç›®ï¼ˆæ”¯æŒå¤šå…³é”®è¯æœç´¢ï¼‰
      function filterLogEntries(container, logData, searchTerm) {
        container.innerHTML = '';
        
        const searchTerms = parseSearchTerms(searchTerm);
        
        const filteredData = logData.filter(entry => {
          return matchesAllTerms(entry.message, searchTerms);
        });
        
        filteredData.forEach(entry => {
          // å…ˆè¿›è¡Œé¢œè‰²å¤„ç†ï¼Œå†è¿›è¡Œæœç´¢é«˜äº®
          let processedMessage = entry.isOSC ? colorizeOSCMessage(entry.message) : entry.message;
          processedMessage = highlightSearchTerm(processedMessage, searchTerm);
          
          const logElement = createLogElementWithProcessedMessage(processedMessage);
          container.appendChild(logElement);
        });
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        container.scrollTop = container.scrollHeight;
        
        // æ˜¾ç¤ºæœç´¢ç»“æœç»Ÿè®¡
        updateSearchStats(container, filteredData.length, logData.length, searchTerms);
      }

      // åˆ›å»ºå¸¦æœ‰å·²å¤„ç†æ¶ˆæ¯çš„æ—¥å¿—å…ƒç´ 
      function createLogElementWithProcessedMessage(processedMessage) {
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        
        const timestamp = new Date().toLocaleTimeString('zh-CN', { 
          hour12: false,
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        
        logEntry.innerHTML = `
          <span class="log-time">[${timestamp}]</span>
          <span class="log-message">${processedMessage}</span>
        `;
        
        return logEntry;
      }

      // æ›´æ–°æœç´¢ç»“æœç»Ÿè®¡
      function updateSearchStats(container, filteredCount, totalCount, searchTerms) {
        // ç§»é™¤ä¹‹å‰çš„ç»Ÿè®¡ä¿¡æ¯
        const existingStats = container.querySelector('.search-stats');
        if (existingStats) {
          existingStats.remove();
        }
        
        // å¦‚æœæœ‰æœç´¢æ¡ä»¶ä¸”ç»“æœä¸ç­‰äºæ€»æ•°ï¼Œæ˜¾ç¤ºç»Ÿè®¡
        if (searchTerms.length > 0 && filteredCount !== totalCount) {
          const statsElement = document.createElement('div');
          statsElement.className = 'search-stats';
          
          const termsText = searchTerms.length > 1 ? 
            `å…³é”®è¯: "${searchTerms.join('", "')}"` : 
            `å…³é”®è¯: "${searchTerms[0]}"`;
          
          statsElement.innerHTML = `
            <div class="search-stats-content">
              <span class="search-icon">ğŸ”</span>
              <span>${termsText}</span>
              <span class="search-count">${filteredCount}/${totalCount} æ¡</span>
            </div>
          `;
          
          container.insertBefore(statsElement, container.firstChild);
        }
      }

      // æ‰§è¡Œæœç´¢
      function performSearch(type) {
        if (type === 'sent') {
          sentSearchTerm = sentSearchInput.value.trim();
          filterLogEntries(sentLogContainer, sentLogData, sentSearchTerm);
          sentClearSearchBtn.style.display = sentSearchTerm ? 'flex' : 'none';
        } else if (type === 'received') {
          receivedSearchTerm = receivedSearchInput.value.trim();
          filterLogEntries(receivedLogContainer, receivedLogData, receivedSearchTerm);
          receivedClearSearchBtn.style.display = receivedSearchTerm ? 'flex' : 'none';
        }
      }

      // æ¸…é™¤æœç´¢
      function clearSearch(type) {
        if (type === 'sent') {
          sentSearchInput.value = '';
          sentSearchTerm = '';
          filterLogEntries(sentLogContainer, sentLogData, '');
          sentClearSearchBtn.style.display = 'none';
          sentSearchInput.focus();
        } else if (type === 'received') {
          receivedSearchInput.value = '';
          receivedSearchTerm = '';
          filterLogEntries(receivedLogContainer, receivedLogData, '');
          receivedClearSearchBtn.style.display = 'none';
          receivedSearchInput.focus();
        }
      }

      // æœç´¢äº‹ä»¶ç›‘å¬å™¨
      sentSearchBtn.addEventListener('click', () => performSearch('sent'));
      sentSearchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') performSearch('sent');
      });
      sentSearchInput.addEventListener('input', () => {
        if (sentSearchInput.value === '') clearSearch('sent');
      });
      sentClearSearchBtn.addEventListener('click', () => clearSearch('sent'));

      receivedSearchBtn.addEventListener('click', () => performSearch('received'));
      receivedSearchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') performSearch('received');
      });
      receivedSearchInput.addEventListener('input', () => {
        if (receivedSearchInput.value === '') clearSearch('received');
      });
      receivedClearSearchBtn.addEventListener('click', () => clearSearch('received'));

      // æ·»åŠ ç³»ç»Ÿæ—¥å¿—
      function addSystemLog(message) {
        const logEntry = createLogElement(message, false);
        systemLogContainer.appendChild(logEntry);
        
        // å­˜å‚¨åˆ°æ•°æ®æ•°ç»„
        systemLogData.push({
          message: message,
          isOSC: false,
          timestamp: Date.now()
        });
        
        limitLogEntries(systemLogContainer, systemLogData, 100);
        systemLogContainer.scrollTop = systemLogContainer.scrollHeight;
      }

      // æ·»åŠ OSCæ—¥å¿—
      function addOSCLog(message, direction) {
        const logData = {
          message: message,
          isOSC: true,
          timestamp: Date.now()
        };
        
        if (direction === 'sent') {
          sentLogData.push(logData);
          const sentSearchTerms = parseSearchTerms(sentSearchTerm);
          if (matchesAllTerms(message, sentSearchTerms)) {
            // å…ˆè¿›è¡Œé¢œè‰²å¤„ç†ï¼Œå†è¿›è¡Œæœç´¢é«˜äº®
            let processedMessage = colorizeOSCMessage(message);
            processedMessage = highlightSearchTerm(processedMessage, sentSearchTerm);
            const logElement = createLogElementWithProcessedMessage(processedMessage);
            sentLogContainer.appendChild(logElement);
          }
          limitLogEntries(sentLogContainer, sentLogData, 100);
          if (sentSearchTerms.length === 0) {
            sentLogContainer.scrollTop = sentLogContainer.scrollHeight;
          } else {
            // å¦‚æœæœ‰æœç´¢æ¡ä»¶ï¼Œæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateSearchStats(sentLogContainer, 
              sentLogContainer.querySelectorAll('.log-entry').length, 
              sentLogData.length, 
              sentSearchTerms);
          }
        } else if (direction === 'received') {
          receivedLogData.push(logData);
          const receivedSearchTerms = parseSearchTerms(receivedSearchTerm);
          if (matchesAllTerms(message, receivedSearchTerms)) {
            // å…ˆè¿›è¡Œé¢œè‰²å¤„ç†ï¼Œå†è¿›è¡Œæœç´¢é«˜äº®
            let processedMessage = colorizeOSCMessage(message);
            processedMessage = highlightSearchTerm(processedMessage, receivedSearchTerm);
            const logElement = createLogElementWithProcessedMessage(processedMessage);
            receivedLogContainer.appendChild(logElement);
          }
          limitLogEntries(receivedLogContainer, receivedLogData, 100);
          if (receivedSearchTerms.length === 0) {
            receivedLogContainer.scrollTop = receivedLogContainer.scrollHeight;
          } else {
            // å¦‚æœæœ‰æœç´¢æ¡ä»¶ï¼Œæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateSearchStats(receivedLogContainer, 
              receivedLogContainer.querySelectorAll('.log-entry').length, 
              receivedLogData.length, 
              receivedSearchTerms);
          }
        }
      }

      // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡
      function limitLogEntries(container, dataArray, maxEntries) {
        // ä»æ•°æ®æ•°ç»„ä¸­ç§»é™¤å¤šä½™çš„æ¡ç›®
        while (dataArray.length > maxEntries) {
          dataArray.shift();
        }
        
        // ä»DOMä¸­ç§»é™¤å¤šä½™çš„æ¡ç›®
        while (container.children.length > maxEntries) {
          container.removeChild(container.firstChild);
        }
      }

      // æ›´æ–°è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨
      function updateConnectionStatus(connected) {
        if (connected) {
          wsStatusIndicator.classList.add('connected');
          wsStatusText.textContent = 'å·²è¿æ¥';
        } else {
          wsStatusIndicator.classList.remove('connected');
          wsStatusText.textContent = 'æœªè¿æ¥';
        }
      }

      // å¤„ç†ä»åç«¯æ¥æ”¶çš„æ—¥å¿—æ¶ˆæ¯
      function handleLogMessage(data) {
        const message = data.message;
        
        // å…³é”®åˆ¤æ–­ï¼šé€šè¿‡æ—¥å¿—å¼€å¤´çš„æ ¼å¼åŒºåˆ†
        // å‘é€æ—¥å¿—: "[WS #...]"
        if (message.startsWith('[WS #')) {
          addOSCLog(message, 'sent');
        } 
        // æ¥æ”¶æ—¥å¿—: "[IP:PORT]" (ä¾‹å¦‚ [127.0.0.1:7879])
        else if (message.match(/^\[\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}:\d+\]/)) {
          addOSCLog(message, 'received');
        }
        // å…¶ä»–æ‰€æœ‰æ¶ˆæ¯éƒ½å½’ä¸ºç³»ç»Ÿæ—¥å¿—
        else {
          addSystemLog(message);
        }
      }

      // WebSocket è¿æ¥ç®¡ç†
      function connectWebSocket() {
        try {
          ws = new WebSocket('ws://localhost:9122');
          
          ws.onopen = function() {
            updateConnectionStatus(true);
            addSystemLog('âœ… WebSocket è¿æ¥å·²å»ºç«‹ (ç«¯å£ 9122)');
            if (reconnectInterval) {
              clearInterval(reconnectInterval);
              reconnectInterval = null;
            }
          };
          
          ws.onmessage = function(event) {
            // åªå¤„ç†å­—ç¬¦ä¸²ç±»å‹çš„æ¶ˆæ¯ï¼Œå¿½ç•¥äºŒè¿›åˆ¶ Blob æ•°æ®
            if (typeof event.data === 'string') {
              try {
                const data = JSON.parse(event.data);
                if (data.type === 'log') {
                  handleLogMessage(data);
                }
              } catch (e) {
                // å¦‚æœå­—ç¬¦ä¸²ä¸æ˜¯æœ‰æ•ˆçš„ JSONï¼Œåˆ™å°†å…¶ä½œä¸ºæ™®é€šç³»ç»Ÿæ¶ˆæ¯è®°å½•
                addSystemLog('æ¥æ”¶åˆ°åŸå§‹æ–‡æœ¬æ¶ˆæ¯: ' + event.data);
              }
            }
            // å¯¹äº Blob ç±»å‹çš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬å‡å®šå®ƒä»¬æ˜¯åŸå§‹OSCæ•°æ®ï¼Œ
            // ä¸åº”åœ¨ç³»ç»Ÿæ—¥å¿—ä¸­æ˜¾ç¤ºï¼Œå› æ­¤åœ¨æ­¤å¤„å¿½ç•¥å®ƒä»¬ã€‚
          };
          
          ws.onclose = function(event) {
            updateConnectionStatus(false);
            if (event.wasClean) {
              addSystemLog('ğŸ”Œ WebSocket è¿æ¥å·²æ­£å¸¸å…³é—­');
            } else {
              addSystemLog('âš ï¸ WebSocket è¿æ¥æ„å¤–æ–­å¼€ï¼Œ10ç§’åé‡è¿...');
              if (!reconnectInterval) {
                reconnectInterval = setInterval(() => {
                  connectWebSocket();
                }, 10000);
              }
            }
          };
          
          ws.onerror = function(error) {
            console.error('WebSocket error:', error);
            addSystemLog('âŒ WebSocket è¿æ¥é”™è¯¯ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨ (ç«¯å£ 9122)');
          };
        } catch (error) {
          addSystemLog('è¿æ¥å¤±è´¥: ' + error.message);
        }
      }

      // å‘é€OSCæ¶ˆæ¯ (å‘é€äºŒè¿›åˆ¶æ ¼å¼)
      function sendOSCMessage(address, args) {
        if (ws && ws.readyState === WebSocket.OPEN) {
          try {
            const osc = new OSC();
            const message = new OSC.Message(address, ...args);
            const binaryPacket = message.pack();
            
            ws.send(binaryPacket);
            addSystemLog(`âœ” å·²å‘é€äºŒè¿›åˆ¶ OSC æ¶ˆæ¯: ${address} ${args.join(' ')}`);

          } catch (error) {
            console.error("åˆ›å»ºæˆ–å‘é€OSCåŒ…æ—¶å‡ºé”™:", error);
            addSystemLog(`âŒ åˆ›å»ºOSCåŒ…å¤±è´¥: ${error.message}`);
          }
        } else {
          addSystemLog('WebSocket æœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯');
        }
      }

      // æ¸…é™¤æ—¥å¿—äº‹ä»¶ç›‘å¬å™¨
      clearSystemLogBtn.addEventListener('click', () => {
        systemLogContainer.innerHTML = '';
        systemLogData = [];
        addSystemLog('ç³»ç»Ÿæ—¥å¿—å·²æ¸…é™¤');
      });

      clearSentLogBtn.addEventListener('click', () => {
        sentLogContainer.innerHTML = '';
        sentLogData = [];
        addSystemLog('å‘é€æ—¥å¿—å·²æ¸…é™¤');
      });

      clearReceivedLogBtn.addEventListener('click', () => {
        receivedLogContainer.innerHTML = '';
        receivedLogData = [];
        addSystemLog('æ¥æ”¶æ—¥å¿—å·²æ¸…é™¤');
      });

      // è¡¨å•æäº¤å¤„ç†
      const oscForm = document.getElementById('osc-form');
      oscForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const address = document.getElementById('osc-address').value;
        const argsText = document.getElementById('osc-args').value;
        const args = argsText.split(',').map(arg => {
          const trimmed = arg.trim();
          // å°è¯•è½¬æ¢ä¸ºæ•°å­—
          const num = parseFloat(trimmed);
          return isNaN(num) ? trimmed : num;
        });
        sendOSCMessage(address, args);
      });

      // ===================== è®¾ç½®åŠŸèƒ½ =====================
      
      const config = {
        wsUrl: 'ws://localhost:9122',
        listenPorts: ['127.0.0.1:7879', '127.0.0.1:9222'],
        forwardTargets: ['127.0.0.1:7878', '127.0.0.1:9223']
      };

      async function saveConfig() {
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('oscBridgeConfig', JSON.stringify(config));
        // ä¿å­˜åˆ°æœåŠ¡å™¨config.json
        await saveConfigToServer();
      }

      function loadConfig() {
        const savedConfig = localStorage.getItem('oscBridgeConfig');
        if (savedConfig) {
          const parsedConfig = JSON.parse(savedConfig);
          // åªåœ¨æœåŠ¡å™¨é…ç½®ä¸å¯ç”¨æ—¶æ‰ä½¿ç”¨æœ¬åœ°é…ç½®
          if (!config.listenPorts || config.listenPorts.length === 0) {
            // éªŒè¯å¹¶ä¿®å¤æœ¬åœ°é…ç½®æ ¼å¼
            if (parsedConfig.listenPorts) {
              parsedConfig.listenPorts = validateAndFixPortFormat(parsedConfig.listenPorts);
            }
            if (parsedConfig.forwardTargets) {
              parsedConfig.forwardTargets = validateAndFixPortFormat(parsedConfig.forwardTargets);
            }
            Object.assign(config, parsedConfig);
            addSystemLog('ğŸ”§ å·²åŠ è½½æœ¬åœ°ä¿å­˜çš„é…ç½®ï¼ˆæœåŠ¡å™¨é…ç½®ä¸å¯ç”¨ï¼‰');
          } else {
            addSystemLog('ğŸ”§ æœåŠ¡å™¨é…ç½®ä¼˜å…ˆï¼Œè·³è¿‡æœ¬åœ°é…ç½®');
          }
        }
      }

      function createSettingItem(value, type) {
        const item = document.createElement('div');
        item.className = 'settings-item';

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'settings-input';
        input.value = value;
        input.addEventListener('change', async (e) => {
          const index = Array.from(item.parentElement.children).indexOf(item);
          if (type === 'listen') {
            config.listenPorts[index] = e.target.value;
          } else {
            config.forwardTargets[index] = e.target.value;
          }
          await saveConfig();
        });

        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn-remove-item';
        removeBtn.textContent = 'åˆ é™¤';
        removeBtn.addEventListener('click', async () => {
          const index = Array.from(item.parentElement.children).indexOf(item);
          if (type === 'listen') {
            config.listenPorts.splice(index, 1);
          } else {
            config.forwardTargets.splice(index, 1);
          }
          await saveConfig();
          populateSettings();
        });

        item.appendChild(input);
        item.appendChild(removeBtn);
        return item;
      }

      function populateSettings() {
        // WebSocket URL
        wsUrlInput.value = config.wsUrl;

        // ç›‘å¬ç«¯å£
        listenPortsContainer.innerHTML = '';
        config.listenPorts.forEach(port => {
          listenPortsContainer.appendChild(createSettingItem(port, 'listen'));
        });

        // è½¬å‘ç›®æ ‡
        forwardTargetsContainer.innerHTML = '';
        config.forwardTargets.forEach(target => {
          forwardTargetsContainer.appendChild(createSettingItem(target, 'forward'));
        });
        
        // æ›´æ–°é¡¶éƒ¨çŠ¶æ€æ æ˜¾ç¤º
        updateHeaderInfo();
      }
      
      function updateHeaderInfo() {
          const listenPortsDisplay = document.getElementById('listen-ports-display');
          const targetPortsDisplay = document.getElementById('target-ports-display');

          if(listenPortsDisplay) {
              listenPortsDisplay.textContent = formatPortsDisplay(config.listenPorts);
          }
          if(targetPortsDisplay) {
              targetPortsDisplay.textContent = formatPortsDisplay(config.forwardTargets);
          }
      }

      // æ™ºèƒ½æ ¼å¼åŒ–ç«¯å£æ˜¾ç¤º
      function formatPortsDisplay(ports) {
        if (!ports || ports.length === 0) {
          return 'æ— ';
        }
        
        const ipGroups = {};
        
        // æŒ‰IPåˆ†ç»„
        ports.forEach(port => {
          const parts = port.split(':');
          const [ip, portNum] = parts;
          
          // å¦‚æœæ²¡æœ‰IPéƒ¨åˆ†ï¼Œè¯´æ˜åªæœ‰ç«¯å£å·ï¼Œéœ€è¦æ·»åŠ é»˜è®¤IP
          const finalIp = ip && portNum ? ip : '127.0.0.1';
          const finalPort = ip && portNum ? portNum : parts[0];
          
          if (!ipGroups[finalIp]) {
            ipGroups[finalIp] = [];
          }
          ipGroups[finalIp].push(finalPort);
        });
        
        // æ ¼å¼åŒ–æ˜¾ç¤º
        const formatted = Object.entries(ipGroups).map(([ip, portList]) => {
          if (portList.length === 1) {
            return `${ip}:${portList[0]}`;
          } else {
            return `${ip}:${portList.join('/')}`;
          }
        });
        
        return formatted.join(' || ');
      }

      // æ˜¾ç¤ºé€šçŸ¥
      function showNotification(message, type = 'info') {
        addSystemLog(`${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'} ${message}`);
      }

      // éªŒè¯å¹¶ä¿®å¤ç«¯å£æ ¼å¼
      function validateAndFixPortFormat(ports, defaultIp = '127.0.0.1') {
        return ports.map(port => {
          // å¦‚æœå·²ç»æ˜¯å®Œæ•´çš„IP:ç«¯å£æ ¼å¼ï¼Œç›´æ¥è¿”å›
          if (port.includes(':')) {
            return port;
          }
          // å¦‚æœåªæ˜¯ç«¯å£å·ï¼Œæ·»åŠ é»˜è®¤IP
          return `${defaultIp}:${port}`;
        });
      }

      // ä»æœåŠ¡å™¨åŠ è½½é…ç½®
      async function loadConfigFromServer() {
        try {
          console.log('ğŸ”„ å¼€å§‹ä»æœåŠ¡å™¨åŠ è½½é…ç½®...');
          const response = await fetch('http://localhost:9122/config');
          
          console.log('ğŸ“¡ å“åº”çŠ¶æ€:', response.status, response.statusText);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const serverConfig = await response.json();
          console.log('ğŸ“„ æœåŠ¡å™¨é…ç½®æ•°æ®:', serverConfig);
          
          // æ›´æ–°æœ¬åœ°é…ç½®å¹¶éªŒè¯æ ¼å¼
          config.wsUrl = serverConfig.WS[0] || 'ws://localhost:9122';
          config.listenPorts = validateAndFixPortFormat(serverConfig.ListenPorts || []);
          config.forwardTargets = validateAndFixPortFormat(serverConfig.TargetPorts || []);
          
          console.log('ğŸ“¥ ä»æœåŠ¡å™¨åŠ è½½é…ç½®æˆåŠŸ:', {
            ç›‘å¬ç«¯å£: config.listenPorts,
            è½¬å‘ç›®æ ‡: config.forwardTargets
          });
          
          showNotification('é…ç½®åŠ è½½æˆåŠŸ', 'success');
          updateHeaderInfo();
        } catch (error) {
          console.error('âŒ åŠ è½½é…ç½®å¤±è´¥è¯¦æƒ…:', error);
          showNotification(`åŠ è½½é…ç½®å¤±è´¥: ${error.message}`, 'error');
          
          // å¦‚æœæœåŠ¡å™¨é…ç½®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
          console.log('ğŸ”„ ä½¿ç”¨é»˜è®¤é…ç½®ä½œä¸ºåå¤‡');
          updateHeaderInfo();
        }
      }

      // ä¿å­˜é…ç½®åˆ°æœåŠ¡å™¨
      async function saveConfigToServer() {
        try {
          const serverConfig = {
            ListenPorts: config.listenPorts,
            TargetPorts: config.forwardTargets,
            WS: [config.wsUrl]
          };

          console.log('ğŸ’¾ ä¿å­˜é…ç½®åˆ°æœåŠ¡å™¨:', serverConfig);

          const response = await fetch('http://localhost:9122/save-config', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(serverConfig)
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const result = await response.json();
          
          if (result.success) {
            console.log('âœ… é…ç½®ä¿å­˜æˆåŠŸ');
            showNotification('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
            updateHeaderInfo();
          } else {
            throw new Error(result.message);
          }
        } catch (error) {
          console.error('âŒ ä¿å­˜é…ç½®å¤±è´¥:', error);
          showNotification('ä¿å­˜é…ç½®å¤±è´¥: ' + error.message, 'error');
          }
      }

      // äº‹ä»¶ç›‘å¬å™¨
      settingsBtn.addEventListener('click', () => {
        populateSettings();
        settingsModal.style.display = 'flex';
      });

      closeSettingsBtn.addEventListener('click', () => {
        settingsModal.style.display = 'none';
      });

      // å…³é—­æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
      const closeBtn = document.getElementById('close-btn');
      if (closeBtn) {
        console.log('æ‰¾åˆ°å…³é—­æŒ‰é’®ï¼Œæ­£åœ¨æ·»åŠ äº‹ä»¶ç›‘å¬å™¨');
        closeBtn.addEventListener('click', async () => {
          console.log('å…³é—­æŒ‰é’®è¢«ç‚¹å‡»äº†ï¼');
          try {
            // åœ¨Tauriç¯å¢ƒä¸­ï¼Œä½¿ç”¨window.__TAURI__æ¥è®¿é—®Tauri API
            if (window.__TAURI__) {
              const { WebviewWindow } = window.__TAURI__.webviewWindow;
              const currentWindow = WebviewWindow.getCurrent();
              if (currentWindow) {
                await currentWindow.hide();
                console.log('çª—å£å·²éšè—');
              }
            } else {
              console.log('ä¸åœ¨Tauriç¯å¢ƒä¸­ï¼Œæ— æ³•éšè—çª—å£');
            }
          } catch (error) {
            console.error('éšè—çª—å£å¤±è´¥:', error);
          }
        });
        console.log('å…³é—­æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²æ·»åŠ ');
      } else {
        console.error('æœªæ‰¾åˆ°å…³é—­æŒ‰é’®å…ƒç´ ï¼');
      }
      
      window.addEventListener('click', (e) => {
          if (e.target === settingsModal) {
              settingsModal.style.display = 'none';
          }
      });

      wsUrlInput.addEventListener('change', async (e) => {
        const newUrl = e.target.value;
        if (newUrl !== config.wsUrl) {
          config.wsUrl = newUrl;
          await saveConfig();
        addSystemLog('â„¹ï¸ WebSocket åœ°å€å·²æ›´æ–°ï¼Œé‡æ–°è¿æ¥åç”Ÿæ•ˆ');
        ws.close(); // å…³é—­å½“å‰è¿æ¥ä»¥è§¦å‘é‡è¿
        }
      });

      addListenPortBtn.addEventListener('click', async () => {
        config.listenPorts.push('127.0.0.1:æ–°ç«¯å£');
        populateSettings();
        await saveConfig();
      });

      addForwardTargetBtn.addEventListener('click', async () => {
        config.forwardTargets.push('127.0.0.1:æ–°ç«¯å£');
        populateSettings();
        await saveConfig();
      });

      // æ¸…ç†å’ŒéªŒè¯é…ç½®
      function cleanupAndValidateConfig() {
        // éªŒè¯å½“å‰é…ç½®æ ¼å¼
        config.listenPorts = validateAndFixPortFormat(config.listenPorts);
        config.forwardTargets = validateAndFixPortFormat(config.forwardTargets);
        
        // æ¸…ç†æœ¬åœ°å­˜å‚¨ä¸­å¯èƒ½çš„é”™è¯¯é…ç½®
        const savedConfig = localStorage.getItem('oscBridgeConfig');
        if (savedConfig) {
          try {
            const parsedConfig = JSON.parse(savedConfig);
            const needsUpdate = 
              (parsedConfig.listenPorts && parsedConfig.listenPorts.some(port => !port.includes(':'))) ||
              (parsedConfig.forwardTargets && parsedConfig.forwardTargets.some(target => !target.includes(':')));
            
            if (needsUpdate) {
              localStorage.removeItem('oscBridgeConfig');
              addSystemLog('ğŸ§¹ å·²æ¸…ç†æ—§ç‰ˆæœ¬é…ç½®æ ¼å¼');
            }
          } catch (e) {
            console.error('æ¸…ç†æœ¬åœ°é…ç½®æ—¶å‡ºé”™:', e);
            localStorage.removeItem('oscBridgeConfig');
          }
        }
      }

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥
      window.addEventListener('load', async () => {
        // è®¾ç½®åˆå§‹è¿æ¥çŠ¶æ€
        updateConnectionStatus(false);
        addSystemLog('ğŸš€ OSC Bridge æ§åˆ¶é¢æ¿å·²å¯åŠ¨');
        
        // 1. å…ˆæ¸…ç†å’ŒéªŒè¯é»˜è®¤é…ç½®
        cleanupAndValidateConfig();
        
        // 2. åŠ è½½é…ç½®ï¼ˆä¼˜å…ˆä»æœåŠ¡å™¨åŠ è½½ï¼‰
        await loadConfigFromServer();
        loadConfig(); // å¤‡ç”¨æœ¬åœ°é…ç½®
        populateSettings();
        
        addSystemLog('ğŸ”„ æ­£åœ¨è¿æ¥åˆ°åç«¯æœåŠ¡ (' + config.wsUrl + ')...');
        connectWebSocket();
      });
    </script>
  </body>
</html>
