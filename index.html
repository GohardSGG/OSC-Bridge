<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="/src/styles.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OSC Bridge - æ§åˆ¶é¢æ¿</title>

  </head>

  <body>
    <div class="container">
      <header class="header">
        <div class="status-item">
          <span class="status-indicator" id="ws-status"></span>
          <span>WebSocket: </span>
          <span id="ws-status-text">æœªè¿æ¥</span>
        </div>
        <div class="status-item">
          <span>ç›‘å¬ç«¯å£: 7879, 9222</span>
        </div>
        <div class="status-item">
          <span>è½¬å‘ç›®æ ‡: 127.0.0.1:7878, 127.0.0.1:9223</span>
        </div>
      </header>

      <div class="main-content">
        <!-- å·¦ä¾§ä¸»é¢æ¿ -->
        <div class="main-panel">
          <div class="card">
            <form id="osc-form">
            <div class="form-group">
                <label for="osc-address">OSC åœ°å€</label>
                <input type="text" id="osc-address" value="/track/1/volume">
            </div>
            <div class="form-group">
                <label for="osc-args">å‚æ•° (ä»¥é€—å·åˆ†éš”)</label>
                <input type="text" id="osc-args" value="0.75">
              </div>
              <button type="submit" class="btn btn-primary">å‘é€</button>
            </form>
            </div>
            
          <!-- ç³»ç»Ÿæ—¥å¿—åŒºåŸŸ -->
          <div class="card system-log-card">
            <div class="log-header">
              <h4>ç³»ç»Ÿæ—¥å¿—</h4>
              <button id="clear-system-log" class="clear-icon-btn" title="æ¸…é™¤ç³»ç»Ÿæ—¥å¿—">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3,6 5,6 21,6"></polyline>
                  <path d="m19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1 2-2h4a2,2 0 0,1 2,2v2"></path>
                  <line x1="10" y1="11" x2="10" y2="17"></line>
                  <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
              </button>
            </div>
            <div id="system-log-container" class="log-container"></div>
          </div>
        </div>

        <!-- å³ä¾§OSCæ—¥å¿—ä¾§è¾¹æ  -->
        <div class="side-panel">
            <div class="log-controls">
            <h4>OSC æ¶ˆæ¯æ—¥å¿—</h4>
            <div>
              <label class="checkbox-label">
                <input type="checkbox" id="auto-scroll" checked>
                è‡ªåŠ¨æ»šåŠ¨
              </label>
            </div>
          </div>
          <div class="log-column">
            <div class="log-header">
              <h3>å‘é€ OSC (â†’)</h3>
              <div class="log-controls-inline">
                <div class="search-box">
                  <input type="text" id="sent-search" class="search-input" placeholder="æœç´¢... (æ”¯æŒå¤šå…³é”®è¯)" title="æœç´¢å‘é€æ—¥å¿—ï¼Œæ”¯æŒç©ºæ ¼åˆ†éš”å¤šä¸ªå…³é”®è¯">
                  <button id="sent-search-btn" class="search-btn" title="æœç´¢">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.35-4.35"></path>
                    </svg>
                  </button>
                  <button id="sent-clear-search" class="clear-search-btn" title="æ¸…é™¤æœç´¢" style="display: none;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </div>
                <button id="clear-sent-log" class="clear-icon-btn" title="æ¸…é™¤å‘é€æ—¥å¿—">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3,6 5,6 21,6"></polyline>
                    <path d="m19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1 2-2h4a2,2 0 0,1 2,2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                  </svg>
                </button>
              </div>
            </div>
            <div id="sent-log-container" class="log-container"></div>
          </div>
          <div class="log-column">
            <div class="log-header">
              <h3>æ¥æ”¶ OSC (â†)</h3>
              <div class="log-controls-inline">
                <div class="search-box">
                  <input type="text" id="received-search" class="search-input" placeholder="æœç´¢... (æ”¯æŒå¤šå…³é”®è¯)" title="æœç´¢æ¥æ”¶æ—¥å¿—ï¼Œæ”¯æŒç©ºæ ¼åˆ†éš”å¤šä¸ªå…³é”®è¯">
                  <button id="received-search-btn" class="search-btn" title="æœç´¢">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.35-4.35"></path>
                    </svg>
                  </button>
                  <button id="received-clear-search" class="clear-search-btn" title="æ¸…é™¤æœç´¢" style="display: none;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </div>
                <button id="clear-received-log" class="clear-icon-btn" title="æ¸…é™¤æ¥æ”¶æ—¥å¿—">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3,6 5,6 21,6"></polyline>
                    <path d="m19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1 2-2h4a2,2 0 0,1 2,2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                  </svg>
                </button>
              </div>
            </div>
            <div id="received-log-container" class="log-container"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // å­˜å‚¨åŸå§‹æ—¥å¿—æ•°æ®
      let sentLogData = [];
      let receivedLogData = [];
      let systemLogData = [];

      // æœç´¢çŠ¶æ€
      let sentSearchTerm = '';
      let receivedSearchTerm = '';

      // WebSocket è¿æ¥
      let ws;
      let reconnectInterval;

      // è·å–DOMå…ƒç´ 
      const systemLogContainer = document.getElementById('system-log-container');
      const sentLogContainer = document.getElementById('sent-log-container');
      const receivedLogContainer = document.getElementById('received-log-container');
      const clearSystemLogBtn = document.getElementById('clear-system-log');
      const clearSentLogBtn = document.getElementById('clear-sent-log');
      const clearReceivedLogBtn = document.getElementById('clear-received-log');
      
      // çŠ¶æ€æŒ‡ç¤ºå™¨å…ƒç´ 
      const wsStatusIndicator = document.getElementById('ws-status');
      const wsStatusText = document.getElementById('ws-status-text');
      
      // æœç´¢ç›¸å…³å…ƒç´ 
      const sentSearchInput = document.getElementById('sent-search');
      const sentSearchBtn = document.getElementById('sent-search-btn');
      const sentClearSearchBtn = document.getElementById('sent-clear-search');
      const receivedSearchInput = document.getElementById('received-search');
      const receivedSearchBtn = document.getElementById('received-search-btn');
      const receivedClearSearchBtn = document.getElementById('received-clear-search');

      // åˆ›å»ºæ—¥å¿—å…ƒç´ 
      function createLogElement(message, isOSC = false) {
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        
        const timestamp = new Date().toLocaleTimeString('zh-CN', { 
          hour12: false,
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        
        logEntry.innerHTML = `
          <span class="log-time">[${timestamp}]</span>
          <span class="log-message">${message}</span>
        `;
        
        return logEntry;
      }

      // è§£ææœç´¢å…³é”®è¯ï¼ˆæ”¯æŒå¤šå…³é”®è¯ç©ºæ ¼åˆ†éš”ï¼‰
      function parseSearchTerms(searchTerm) {
        if (!searchTerm) return [];
        return searchTerm.trim().split(/\s+/).filter(term => term.length > 0);
      }

      // æ£€æŸ¥æ–‡æœ¬æ˜¯å¦åŒ¹é…æ‰€æœ‰æœç´¢å…³é”®è¯
      function matchesAllTerms(text, searchTerms) {
        if (!searchTerms || searchTerms.length === 0) return true;
        
        const lowerText = text.toLowerCase();
        return searchTerms.every(term => 
          lowerText.includes(term.toLowerCase())
        );
      }

      // é«˜äº®æœç´¢å…³é”®è¯ï¼ˆæ”¯æŒå¤šå…³é”®è¯ï¼‰
      function highlightSearchTerm(text, searchTerm) {
        if (!searchTerm) return text;
        
        const searchTerms = parseSearchTerms(searchTerm);
        if (searchTerms.length === 0) return text;
        
        let highlightedText = text;
        
        // æŒ‰å…³é”®è¯é•¿åº¦å€’åºæ’åˆ—ï¼Œé¿å…çŸ­å…³é”®è¯è¦†ç›–é•¿å…³é”®è¯çš„é«˜äº®
        const sortedTerms = searchTerms.sort((a, b) => b.length - a.length);
        
        sortedTerms.forEach(term => {
          const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const regex = new RegExp(`(${escapedTerm})`, 'gi');
          highlightedText = highlightedText.replace(regex, '<span class="highlight">$1</span>');
        });
        
        return highlightedText;
      }

      // è¿‡æ»¤æ—¥å¿—æ¡ç›®ï¼ˆæ”¯æŒå¤šå…³é”®è¯æœç´¢ï¼‰
      function filterLogEntries(container, logData, searchTerm) {
        container.innerHTML = '';
        
        const searchTerms = parseSearchTerms(searchTerm);
        
        const filteredData = logData.filter(entry => {
          return matchesAllTerms(entry.message, searchTerms);
        });
        
        filteredData.forEach(entry => {
          const logElement = createLogElement(
            highlightSearchTerm(entry.message, searchTerm),
            entry.isOSC
          );
          container.appendChild(logElement);
        });
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        container.scrollTop = container.scrollHeight;
        
        // æ˜¾ç¤ºæœç´¢ç»“æœç»Ÿè®¡
        updateSearchStats(container, filteredData.length, logData.length, searchTerms);
      }

      // æ›´æ–°æœç´¢ç»“æœç»Ÿè®¡
      function updateSearchStats(container, filteredCount, totalCount, searchTerms) {
        // ç§»é™¤ä¹‹å‰çš„ç»Ÿè®¡ä¿¡æ¯
        const existingStats = container.querySelector('.search-stats');
        if (existingStats) {
          existingStats.remove();
        }
        
        // å¦‚æœæœ‰æœç´¢æ¡ä»¶ä¸”ç»“æœä¸ç­‰äºæ€»æ•°ï¼Œæ˜¾ç¤ºç»Ÿè®¡
        if (searchTerms.length > 0 && filteredCount !== totalCount) {
          const statsElement = document.createElement('div');
          statsElement.className = 'search-stats';
          
          const termsText = searchTerms.length > 1 ? 
            `å…³é”®è¯: "${searchTerms.join('", "')}"` : 
            `å…³é”®è¯: "${searchTerms[0]}"`;
          
          statsElement.innerHTML = `
            <div class="search-stats-content">
              <span class="search-icon">ğŸ”</span>
              <span>${termsText}</span>
              <span class="search-count">${filteredCount}/${totalCount} æ¡</span>
            </div>
          `;
          
          container.insertBefore(statsElement, container.firstChild);
        }
      }

      // æ‰§è¡Œæœç´¢
      function performSearch(type) {
        if (type === 'sent') {
          sentSearchTerm = sentSearchInput.value.trim();
          filterLogEntries(sentLogContainer, sentLogData, sentSearchTerm);
          sentClearSearchBtn.style.display = sentSearchTerm ? 'flex' : 'none';
        } else if (type === 'received') {
          receivedSearchTerm = receivedSearchInput.value.trim();
          filterLogEntries(receivedLogContainer, receivedLogData, receivedSearchTerm);
          receivedClearSearchBtn.style.display = receivedSearchTerm ? 'flex' : 'none';
        }
      }

      // æ¸…é™¤æœç´¢
      function clearSearch(type) {
        if (type === 'sent') {
          sentSearchInput.value = '';
          sentSearchTerm = '';
          filterLogEntries(sentLogContainer, sentLogData, '');
          sentClearSearchBtn.style.display = 'none';
          sentSearchInput.focus();
        } else if (type === 'received') {
          receivedSearchInput.value = '';
          receivedSearchTerm = '';
          filterLogEntries(receivedLogContainer, receivedLogData, '');
          receivedClearSearchBtn.style.display = 'none';
          receivedSearchInput.focus();
        }
      }

      // æœç´¢äº‹ä»¶ç›‘å¬å™¨
      sentSearchBtn.addEventListener('click', () => performSearch('sent'));
      sentSearchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') performSearch('sent');
      });
      sentSearchInput.addEventListener('input', () => {
        if (sentSearchInput.value === '') clearSearch('sent');
      });
      sentClearSearchBtn.addEventListener('click', () => clearSearch('sent'));

      receivedSearchBtn.addEventListener('click', () => performSearch('received'));
      receivedSearchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') performSearch('received');
      });
      receivedSearchInput.addEventListener('input', () => {
        if (receivedSearchInput.value === '') clearSearch('received');
      });
      receivedClearSearchBtn.addEventListener('click', () => clearSearch('received'));

      // æ·»åŠ ç³»ç»Ÿæ—¥å¿—
      function addSystemLog(message) {
        const logEntry = createLogElement(message, false);
        systemLogContainer.appendChild(logEntry);
        
        // å­˜å‚¨åˆ°æ•°æ®æ•°ç»„
        systemLogData.push({
          message: message,
          isOSC: false,
          timestamp: Date.now()
        });
        
        limitLogEntries(systemLogContainer, systemLogData, 100);
        systemLogContainer.scrollTop = systemLogContainer.scrollHeight;
      }

      // æ·»åŠ OSCæ—¥å¿—
      function addOSCLog(message, direction) {
        const logData = {
          message: message,
          isOSC: true,
          timestamp: Date.now()
        };
        
        if (direction === 'sent') {
          sentLogData.push(logData);
          const sentSearchTerms = parseSearchTerms(sentSearchTerm);
          if (matchesAllTerms(message, sentSearchTerms)) {
            const logElement = createLogElement(
              highlightSearchTerm(message, sentSearchTerm),
              true
            );
            sentLogContainer.appendChild(logElement);
          }
          limitLogEntries(sentLogContainer, sentLogData, 100);
          if (sentSearchTerms.length === 0) {
            sentLogContainer.scrollTop = sentLogContainer.scrollHeight;
          } else {
            // å¦‚æœæœ‰æœç´¢æ¡ä»¶ï¼Œæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateSearchStats(sentLogContainer, 
              sentLogContainer.querySelectorAll('.log-entry').length, 
              sentLogData.length, 
              sentSearchTerms);
          }
        } else if (direction === 'received') {
          receivedLogData.push(logData);
          const receivedSearchTerms = parseSearchTerms(receivedSearchTerm);
          if (matchesAllTerms(message, receivedSearchTerms)) {
            const logElement = createLogElement(
              highlightSearchTerm(message, receivedSearchTerm),
              true
            );
            receivedLogContainer.appendChild(logElement);
          }
          limitLogEntries(receivedLogContainer, receivedLogData, 100);
          if (receivedSearchTerms.length === 0) {
            receivedLogContainer.scrollTop = receivedLogContainer.scrollHeight;
          } else {
            // å¦‚æœæœ‰æœç´¢æ¡ä»¶ï¼Œæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateSearchStats(receivedLogContainer, 
              receivedLogContainer.querySelectorAll('.log-entry').length, 
              receivedLogData.length, 
              receivedSearchTerms);
          }
        }
      }

      // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡
      function limitLogEntries(container, dataArray, maxEntries) {
        // ä»æ•°æ®æ•°ç»„ä¸­ç§»é™¤å¤šä½™çš„æ¡ç›®
        while (dataArray.length > maxEntries) {
          dataArray.shift();
        }
        
        // ä»DOMä¸­ç§»é™¤å¤šä½™çš„æ¡ç›®
        while (container.children.length > maxEntries) {
          container.removeChild(container.firstChild);
        }
      }

      // æ›´æ–°è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨
      function updateConnectionStatus(connected) {
        if (connected) {
          wsStatusIndicator.classList.add('connected');
          wsStatusText.textContent = 'å·²è¿æ¥';
        } else {
          wsStatusIndicator.classList.remove('connected');
          wsStatusText.textContent = 'æœªè¿æ¥';
        }
      }

      // å¤„ç†ä»åç«¯æ¥æ”¶çš„æ—¥å¿—æ¶ˆæ¯
      function handleLogMessage(data) {
        const message = data.message;
        
        if (message.includes('â†’')) {
          // å‘é€æ–¹å‘çš„æ—¥å¿—
          addOSCLog(message, 'sent');
        } else if (message.includes('â†')) {
          // æ¥æ”¶æ–¹å‘çš„æ—¥å¿—
          addOSCLog(message, 'received');
        } else {
          // ç³»ç»Ÿæ—¥å¿—
          addSystemLog(message);
        }
      }

      // WebSocket è¿æ¥ç®¡ç†
      function connectWebSocket() {
        try {
          ws = new WebSocket('ws://localhost:9122');
          
          ws.onopen = function() {
            updateConnectionStatus(true);
            addSystemLog('âœ… WebSocket è¿æ¥å·²å»ºç«‹ (ç«¯å£ 9122)');
            if (reconnectInterval) {
              clearInterval(reconnectInterval);
              reconnectInterval = null;
            }
          };
          
          ws.onmessage = function(event) {
            try {
              const data = JSON.parse(event.data);
              if (data.type === 'log') {
                handleLogMessage(data);
              }
            } catch (e) {
              addSystemLog('æ¥æ”¶åˆ°æ¶ˆæ¯: ' + event.data);
            }
          };
          
          ws.onclose = function(event) {
            updateConnectionStatus(false);
            if (event.wasClean) {
              addSystemLog('ğŸ”Œ WebSocket è¿æ¥å·²æ­£å¸¸å…³é—­');
            } else {
              addSystemLog('âš ï¸ WebSocket è¿æ¥æ„å¤–æ–­å¼€ï¼Œ3ç§’åé‡è¿...');
              if (!reconnectInterval) {
                reconnectInterval = setInterval(() => {
                  connectWebSocket();
                }, 3000);
              }
            }
          };
          
          ws.onerror = function(error) {
            console.error('WebSocket error:', error);
            addSystemLog('âŒ WebSocket è¿æ¥é”™è¯¯ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨ (ç«¯å£ 9122)');
          };
        } catch (error) {
          addSystemLog('è¿æ¥å¤±è´¥: ' + error.message);
        }
      }

      // å‘é€OSCæ¶ˆæ¯
      function sendOSCMessage(address, args) {
        if (ws && ws.readyState === WebSocket.OPEN) {
          const message = {
            type: 'osc',
            address: address,
            args: args
          };
          ws.send(JSON.stringify(message));
          addSystemLog(`å‘é€ OSC æ¶ˆæ¯: ${address} ${args.join(' ')}`);
        } else {
          addSystemLog('WebSocket æœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯');
        }
      }

      // æ¸…é™¤æ—¥å¿—äº‹ä»¶ç›‘å¬å™¨
      clearSystemLogBtn.addEventListener('click', () => {
        systemLogContainer.innerHTML = '';
        systemLogData = [];
        addSystemLog('ç³»ç»Ÿæ—¥å¿—å·²æ¸…é™¤');
      });

      clearSentLogBtn.addEventListener('click', () => {
        sentLogContainer.innerHTML = '';
        sentLogData = [];
        addSystemLog('å‘é€æ—¥å¿—å·²æ¸…é™¤');
      });

      clearReceivedLogBtn.addEventListener('click', () => {
        receivedLogContainer.innerHTML = '';
        receivedLogData = [];
        addSystemLog('æ¥æ”¶æ—¥å¿—å·²æ¸…é™¤');
      });

      // è¡¨å•æäº¤å¤„ç†
      const oscForm = document.getElementById('osc-form');
      oscForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const address = document.getElementById('osc-address').value;
        const argsText = document.getElementById('osc-args').value;
        const args = argsText.split(',').map(arg => {
          const trimmed = arg.trim();
          // å°è¯•è½¬æ¢ä¸ºæ•°å­—
          const num = parseFloat(trimmed);
          return isNaN(num) ? trimmed : num;
        });
        sendOSCMessage(address, args);
      });

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥
      window.addEventListener('load', () => {
        // è®¾ç½®åˆå§‹è¿æ¥çŠ¶æ€
        updateConnectionStatus(false);
        addSystemLog('ğŸš€ OSC Bridge æ§åˆ¶é¢æ¿å·²å¯åŠ¨');
        addSystemLog('ğŸ”„ æ­£åœ¨è¿æ¥åˆ°åç«¯æœåŠ¡ (ws://localhost:9122)...');
        connectWebSocket();
      });
    </script>
  </body>
</html>
