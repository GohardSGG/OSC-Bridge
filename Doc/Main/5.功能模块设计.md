# 5. 功能模块设计 (Functional Module Design)

## 5.1 流量监视器 (Traffic Monitor)
- **文件**: `Source/Svelte/lib/components/TrafficMonitor.svelte`
- **职责**: 可视化展示网络吞吐量。
- **实现细节**:
    - 接收后端推送的 `fps` (每秒帧/包数) 数据。
    - 使用 SVG `<polyline>` 绘制动态波形。
    - 维护一个长度为 60 的数组，模拟 1 分钟的历史数据窗口。
    - 包含两个独立波形：绿色 (Inbound) 和 橙色 (Outbound)。

## 5.2 设置模态框 (Settings Modal)
- **文件**: `Source/Svelte/lib/components/SettingsModal.svelte`
- **职责**: 管理应用的所有配置项。
- **关键设计**:
    - **Buffer 机制 (缓冲)**: 打开时复制 Store 到 `local` 变量，关闭时丢弃，保存时才 Commit。
    - **预览与撤销**: UI Scale (缩放) 支持拖动即时预览，但取消操作会触发 Scale 回滚。
    - **视觉保护**: 遮罩层 (Backdrop) 使用 `top-[3px] right-[4px]...` 偏移，防止覆盖 Windows 窗口自带的边框。
    - **布局优化**:
        - 采用 **2列 Grid 布局**：左侧为 "外观/语言" (Language, UI Scale)，右侧为 "系统行为" (Auto Start, Silent Start)，视觉权重更平衡。
        - **无限滚动支持**: 容器应用 `max-height: 85vh` 限制，当配置项（如 Source/Target 列表）过多时自动出现滚动条，防止溢出屏幕。
    - **交互体验**:
        - **精准点击**: Toggle 开关仅响应图标区域点击，防止误触整行。
        - **防误触设计**: 右侧开关组增加额外间距，避免密集排列导致的误操作。

## 5.3 任务调度器 (Task Scheduler / schtasks)
- **文件**: `Source/Tauri/src/schtasks.rs`
- **职责**: 处理 Windows 开机自启。
- **实现细节**:
    - 不使用注册表 Run Key (权限不足)。
    - 生成 XML 任务定义文件。
    - 调用 `schtasks.exe /Create /XML ...`。
    - 关键参数：
        - `LogonType`: `InteractiveToken` (确保有界面)。
        - `RunLevel`: `HighestAvailable` (管理员权限)。
        - 传入 `--silent` 参数给主程序，使其启动时隐藏到托盘。

## 5.4 托盘菜单 (System Tray)
- **职责**: 提供后台运行时的控制入口。
- **功能**:
    - `Open`: 显示主界面。
    - `Quit`: 完全退出程序。
    - 左键单击托盘图标：切换显示/隐藏状态。

## 5.5 OSC 核心 (OSC Core)
- **文件**: `Source/Tauri/src/osc.rs` (假设或类似)
- **职责**: UDP 包的收发与解析。
- **逻辑**:
    - 启动 Tokio UDP Socket 绑定配置端口。
    - 循环 `recv_from` 读取数据。
    - `rosc::decoder::decode` 解析 Packet。
    - 遍历 `forward_targets` 进行转发。
    - 通过 `Window::emit` 将数据发送给前端进行流量统计。
